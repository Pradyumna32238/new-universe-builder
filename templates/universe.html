{% extends "base.html" %}

{% block title %}{{ universe.title }} - Universe Builder{% endblock %}

{% block content %}
  <section class="page-header">
    <h2>{{ universe.title }}</h2>
    <p>{{ universe.description or "No description provided for this universe." }}</p>
    {% if current_user.is_authenticated and not current_user.is_admin and universe.owner_id == current_user.id %}
      <a href="{{ url_for('edit_universe', universe_id=universe.id) }}" class="button">Edit Universe</a>
    {% endif %}
  </section>

  <div class="settings-tabs universe-tabs" role="tablist" aria-label="Universe categories">
    <button class="settings-tab is-active" onclick="showTab('characters')" id="tab-characters" aria-selected="true" aria-controls="universe-characters">Characters</button>
    {% if not current_user.is_admin %}
    <button class="settings-tab" onclick="showTab('add-character')" id="tab-add-character" aria-selected="false" aria-controls="universe-add-character">Add/Request Character</button>
    {% endif %}
    {% if current_user.is_authenticated and universe.owner_id == current_user.id %}
    <button class="settings-tab" onclick="showTab('collab-requests')" id="tab-collab-requests" aria-selected="false" aria-controls="universe-collab-requests">Pending Collaboration Requests</button>
    {% elif current_user.is_authenticated and not current_user.is_admin %}
    <button class="settings-tab" onclick="showTab('your-requests')" id="tab-your-requests" aria-selected="false" aria-controls="universe-your-requests">Your Requests</button>
    {% endif %}
  </div>
  <div class="tab-content" id="characters" style="display:block;" role="tabpanel" aria-labelledby="tab-characters">
    <section class="characters-section">
      <header class="section-header">
        <h3>Characters</h3>
        <p>Add memorable characters to bring this universe to life.</p>
      </header>

      <form method="get" action="{{ url_for('universe_detail', universe_id=universe.id) }}" class="search-form">
        <input type="text" id="search" name="q" class="search-input" placeholder="Search by name" value="{{ search_query }}">
        <button type="submit" class="search-button">Search</button>
      </form>

      {% if characters.items %}
        <ul class="character-list">
          {% for character in characters.items %}
            <li class="character-card">
              <div class="character-info">
                <h4>{{ character.name }}</h4>
                <p>{{ character.description or "No description." }}</p>
              </div>
              <div class="character-actions">
                {% if current_user.is_authenticated and (character.creator_id == current_user.id or universe.owner_id == current_user.id) and not current_user.is_admin %}
                  <details class="character-edit" id="edit-details-{{ character.id }}">
                    <summary class="button secondary small" role="button">Edit</summary>
                    <form method="POST" action="{{ url_for('edit_character', character_id=character.id) }}" class="character-edit-form">
                      <label for="edit-name-{{ character.id }}">Name</label>
                      <input type="text" id="edit-name-{{ character.id }}" name="name" value="{{ character.name }}" maxlength="120" required style="min-width:220px; width:100%;">

                      <label for="edit-description-{{ character.id }}">Description</label>
                      <textarea id="edit-description-{{ character.id }}" name="description" rows="4" placeholder="Describe traits, roles, or backstory." style="min-width:220px; width:100%;">{{ character.description }}</textarea>

                      <div class="character-edit-actions">
                        <button type="submit" class="button small" style="width:80px; min-width:0;">Save</button>
                      </div>
                    </form>
                  </details>
                  <form method="POST" action="{{ url_for('delete_character', character_id=character.id) }}" onsubmit="return confirm('Are you sure you want to delete this character?');">
                    <button type="submit" class="button danger small">Delete</button>
                  </form>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="placeholder">
          <p>No characters found for this universe.</p>
        </div>
      {% endif %}
    </section>
  </div>

  <div class="tab-content" id="add-character" style="display:none;" role="tabpanel" aria-labelledby="tab-add-character">
    <section class="form-section">
      <h3>Add or Request a Character</h3>
      <p>If you are the universe owner, you can add a character directly. If you are a collaborator, you can request a character to be added.</p>
      <form method="POST" action="{{ url_for('add_character', universe_id=universe.id) }}" class="form">
        <div class="form-group">
          <label for="name">Character Name</label>
          <input type="text" id="name" name="name" required>
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" rows="4" placeholder="Describe the character's traits, role, or backstory."></textarea>
        </div>
        <button type="submit" class="button">Add Character</button>
      </form>
    </section>
  </div>

  <div class="tab-content" id="collab-requests" style="display:none;" role="tabpanel" aria-labelledby="tab-collab-requests">
    <section class="requests-section">
      <h3>Pending Collaboration Requests</h3>
      {% if pending_requests %}
        <ul class="character-list">
          {% for req in pending_requests %}
            <li class="character-card">
              <div class="character-info">
                <h4>{{ req.character_name }}</h4>
                <p>{{ req.character_description or "No description." }}</p>
                <p><small>Requested by: {{ req.requester.username }}</small></p>
              </div>
              <div class="character-actions">
                <form action="{{ url_for('approve_collaboration_request', universe_id=universe.id, request_id=req.id) }}" method="post" style="display: inline;">
                  <button type="submit" class="button small">Approve</button>
                </form>
                <form action="{{ url_for('reject_collaboration_request', universe_id=universe.id, request_id=req.id) }}" method="post" style="display: inline;">
                  <button type="submit" class="button danger small">Reject</button>
                </form>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="placeholder">
          <p>No pending character requests.</p>
        </div>
      {% endif %}
    </section>
  </div>

  <div class="tab-content" id="your-requests" style="display:none;" role="tabpanel" aria-labelledby="tab-your-requests">
    <section class="requests-section">
      <h3>Your Requests</h3>
      {% if user_requests %}
        <ul class="character-list">
          {% for req in user_requests %}
            <li class="character-card">
              <div class="character-info">
                <h4>{{ req.character_name }}</h4>
                <p>{{ req.character_description or "No description." }}</p>
              </div>
              <div class="character-actions">
                <span class="status-badge status-{{ req.status }}">{{ req.status }}</span>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="placeholder">
          <p>You haven't made any character requests for this universe.</p>
        </div>
      {% endif %}
    </section>
  </div>
  <script src="{{ url_for('static', filename='js/universe.js') }}"></script>
{% endblock %}