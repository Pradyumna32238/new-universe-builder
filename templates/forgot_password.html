{% extends "base.html" %}

{% block title %}Forgot Password - Universe Builder{% endblock %}

{% block content %}
<section class="page-header">
  <h2>Reset Password</h2>
  <p>Enter your email address to receive a password reset code.</p>
</section>

<section class="form-section">
  <form id="forgot-password-form" action="{{ url_for('forgot_password') }}" method="post" class="form">
    <div class="form-group" id="email-section">
      <label for="email">Email</label>
      <input type="email" id="email" name="email" placeholder="Enter your email" required><br><br>
      <div class="mt-3">
        <button type="button" id="send-otp-btn" class="button">
          <span class="button-text">Send Reset Code</span>
          <div class="loading-spinner" style="display: none;"></div>
        </button>
      </div>
    </div>

    <div id="reset-section" style="display: none;">
      <input type="hidden" id="email-holder" name="email">
      <div class="form-group">
        <label for="otp">OTP</label>
        <input type="text" class="form-control" id="otp" name="otp" required>
      </div>
      <div class="form-group">
        <label for="password">New Password</label>
        <input type="password" class="form-control" id="password" name="new_password" required>
      </div>
      <div class="form-group">
        <label for="password_confirm">Confirm New Password</label>
        <input type="password" class="form-control" id="password_confirm" name="new_password_confirm" required>
        <div id="passwordMatchHint" class="password-match-hint"></div>
      </div>
      <div class="password-requirements" aria-live="polite">
        <p class="password-requirements__title">Make sure your password includes:</p>
        <ul>
          <li data-rule="length">At least 8 characters</li>
          <li data-rule="uppercase">At least one uppercase letter</li>
          <li data-rule="lowercase">At least one lowercase letter</li>
          <li data-rule="number">At least one number</li>
          <li data-rule="special">At least one special character</li>
        </ul>
      </div>
      <button type="submit" class="button primary-pulse">Reset Password</button>
    </div>
  </form>
</section>

<div class="notification" id="notification-popup"></div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/register.js', v='2') }}"></script>
<script>
  document.getElementById('send-otp-btn').addEventListener('click', async function () {
    const email = document.getElementById('email').value;
    if (!email) {
      showNotification('Please enter your email.', 'error');
      return;
    }

    const sendOtpBtn = document.getElementById('send-otp-btn');
    const buttonText = sendOtpBtn.querySelector('.button-text');
    const spinner = sendOtpBtn.querySelector('.loading-spinner');

    buttonText.style.display = 'none';
    spinner.style.display = 'block';
    sendOtpBtn.disabled = true;

    try {
      const response = await fetch('{{ url_for("forgot_password") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          email: email
        })
      });

      const data = await response.json();

      if (data.success) {
        document.getElementById('email-section').style.display = 'none';
        const resetSection = document.getElementById('reset-section');
        resetSection.style.display = 'block';
        document.getElementById('email-holder').value = email;
        showNotification('An OTP has been sent to your email.', 'success');
        initializePasswordValidation(resetSection);
      } else {
        showNotification(data.message || 'Could not send OTP. Please check the email and try again.', 'error');
      }
    } catch (error) {
      showNotification('An error occurred. Please try again.', 'error');
    } finally {
      buttonText.style.display = 'inline';
      spinner.style.display = 'none';
      sendOtpBtn.disabled = false;
    }
  });

  document.getElementById('forgot-password-form').addEventListener('submit', function (event) {
    if (document.getElementById('reset-section').style.display !== 'block') {
      event.preventDefault();
    }
  });

  function showNotification(message, type) {
    const notification = document.getElementById('notification-popup');
    notification.textContent = message;
    notification.className = 'notification'; // Reset classes
    if (type === 'error') {
        notification.classList.add('error');
    }
    notification.classList.add('is-visible');

    setTimeout(() => {
        notification.classList.remove('is-visible');
    }, 5000);
  }
</script>
{% endblock %}